stages:
  - lint
  - build
  - docker
  - deploy

default:
  tags:
    - deploy
    - ec2
  interruptible: true
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

variables:

  NODE_VERSION: "20"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH

# ---------------- LINT ----------------
lint-frontend:
  stage: lint
  script:
    - node -v
    - cd frontend
    - npm ci
    - npm run lint || true   # prevent pipeline fail

# ---------------- BUILD ----------------
build-backend:
  stage: build
  script:
    - node -v
    - cd backend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - backend/dist
    expire_in: 1h

build-frontend:
  stage: build
  script:
    - node -v
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/dist
    expire_in: 1h

# ---------------- DOCKER PUSH ----------------
# Runner must be able to run Docker without sudo (e.g. add gitlab-runner to docker group: usermod -aG docker gitlab-runner).
# Registry credentials: use GitLab CI/CD variables CI_REGISTRY_USER, CI_REGISTRY_PASSWORD, CI_REGISTRY (or set in Settings -> CI/CD -> Variables).
docker-login:
  stage: docker
  before_script:
    # Docker Registry credentials verification
    - echo 'Verifying Docker Registry credentials...'
    - echo "Registry: $CI_REGISTRY"
    - echo "Username: $CI_REGISTRY_USER"
    # Verify credentials by testing docker login
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY" 2>&1 | tee /tmp/docker_login.log
    - |
      if grep -q "Login Succeeded" /tmp/docker_login.log; then
        echo 'Docker login verified successfully'
      else
        echo 'Docker login failed'
        cat /tmp/docker_login.log
        exit 1
      fi
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"

push-backend:
  stage: docker
  needs: ["build-backend"]
  before_script:
    # Verify Docker is running and registry is accessible
    - echo 'Verifying Docker daemon...'
    - docker version
    - echo 'Building and pushing backend Docker image...'
  script:
    - docker build -t $BACKEND_IMAGE backend
    - docker push $BACKEND_IMAGE

push-frontend:
  stage: docker
  needs: ["build-frontend"]
  before_script:
    # Verify Docker is running and registry is accessible
    - echo 'Verifying Docker daemon...'
    - docker version
    - echo 'Building and pushing frontend Docker image...'
  script:
    - docker build -t $FRONTEND_IMAGE frontend
    - docker push $FRONTEND_IMAGE

# ---------------- DEPLOY ----------------
deploy-staging:
  stage: deploy
  before_script:
    # SSH credentials fetch order: Username -> Port -> Password verification
    - echo 'Fetching SSH Username...'
    - SSH_USERNAME="${SSH_USER:-root}"
    - echo "SSH Username: $SSH_USERNAME"
    - echo 'Fetching SSH Port Number...'
    - SSH_PORT="${SSH_PORT:-22}"
    - echo "SSH Port: $SSH_PORT"
    - echo 'Verifying SSH Password...'
    - echo "$SSH_PASSWORD" | sshpass ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p $SSH_PORT $SSH_USERNAME@$SSH_HOST 'exit 0' 2>/dev/null && echo 'Password verified successfully' || echo 'Password verification failed'
  script:
    - echo 'Deploying to STAGING'
  environment:
    name: staging
    url: https://staging.crud-app.com
  needs:
    - push-backend
    - push-frontend
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'

deploy-production:
  stage: deploy
  before_script:
    # SSH credentials fetch order: Username -> Port -> Password verification
    - echo 'Fetching SSH Username...'
    - SSH_USERNAME="${SSH_USER:-root}"
    - echo "SSH Username: $SSH_USERNAME"
    - echo 'Fetching SSH Port Number...'
    - SSH_PORT="${SSH_PORT:-22}"
    - echo "SSH Port: $SSH_PORT"
    - echo 'Verifying SSH Password...'
    - echo "$SSH_PASSWORD" | sshpass ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -p $SSH_PORT $SSH_USERNAME@$SSH_HOST 'exit 0' 2>/dev/null && echo 'Password verified successfully' || echo 'Password verification failed'
  script:
    - echo 'Deploying to PRODUCTION'
  environment:
    name: production
    url: https://crud-app.com
  needs:
    - push-backend
    - push-frontend
  when: manual
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
